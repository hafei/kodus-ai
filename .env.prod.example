# =============================================================================
# Kodus Self-Hosted Production Environment Configuration
# =============================================================================
# This file contains all environment variables needed for running Kodus
# (API + Worker + Webhooks + Web Frontend) in a self-hosted environment.
#
# Instructions:
# 1. Copy this file to .env.prod: cp .env.prod.example .env.prod
# 2. Fill in the required values
# 3. Run: ENV_FILE=.env.prod docker compose -f docker-compose.prod.yml up -d
# =============================================================================

# =============================================================================
# SHARED / GLOBAL VARIABLES
# =============================================================================

# Container names for internal Docker networking
GLOBAL_API_CONTAINER_NAME="kodus-api"
GLOBAL_ANALYTICS_CONTAINER_NAME="kodus-service-analytics"
GLOBAL_BILLING_CONTAINER_NAME="kodus-service-billing"
GLOBAL_MCP_MANAGER_CONTAINER_NAME="kodus-mcp-manager"

# GitLab (shared between API and Web)
GLOBAL_GITLAB_CLIENT_ID=""
GLOBAL_GITLAB_CLIENT_SECRET=""
GLOBAL_GITLAB_REDIRECT_URL="http://localhost:3000/setup/gitlab"

# GitHub (shared)
GLOBAL_GITHUB_CLIENT_ID=""

# Bitbucket webhook
GLOBAL_BITBUCKET_CODE_MANAGEMENT_WEBHOOK=http://localhost:3001/bitbucket/webhook

# Azure Repos webhook
GLOBAL_AZURE_REPOS_CODE_MANAGEMENT_WEBHOOK=http://localhost:3001/azure-repos/webhook

# Kodus Billing Service
GLOBAL_KODUS_SERVICE_BILLING=

# =============================================================================
# WEB FRONTEND VARIABLES
# =============================================================================

# Environment mode
WEB_NODE_ENV="self-hosted"
WEB_PORT=3000

# API Connection (use container name for Docker networking)
WEB_HOSTNAME_API="api"
WEB_PORT_API=3001

# NextAuth
WEB_NEXTAUTH_SECRET=""
NEXTAUTH_URL="http://localhost:3000"

# GitHub OAuth (for web login)
WEB_GITHUB_INSTALL_URL=""
WEB_OAUTH_GITHUB_CLIENT_ID=""
WEB_OAUTH_GITHUB_CLIENT_SECRET=""

# GitLab OAuth
WEB_OAUTH_GITLAB_CLIENT_ID=""
WEB_OAUTH_GITLAB_CLIENT_SECRET=""
WEB_GITLAB_SCOPES="read_api read_user read_repository"
WEB_GITLAB_OAUTH_URL="https://gitlab.com/oauth/authorize"

# Bitbucket
WEB_BITBUCKET_INSTALL_URL=""

# Analytics Service
WEB_ANALYTICS_HOSTNAME="https://qa.service.analytics.kodus.io"
WEB_ANALYTICS_SECRET=""
WEB_PORT_ANALYTICS=3005

# Billing Service
WEB_HOSTNAME_BILLING="localhost"
WEB_PORT_BILLING=3992

# MCP Manager
WEB_HOSTNAME_MCP_MANAGER="localhost"
WEB_PORT_MCP_MANAGER=3101

# PostHog Analytics
WEB_POSTHOG_KEY=

# Documentation URLs
WEB_TERMS_AND_CONDITIONS=""
WEB_TOKEN_DOCS_GITHUB=https://docs.kodus.io/how_to_use/en/code_review/general_config/github_pat
WEB_TOKEN_DOCS_GITLAB=https://docs.kodus.io/how_to_use/en/code_review/general_config/gitlab_pat
WEB_TOKEN_DOCS_BITBUCKET=https://docs.kodus.io/how_to_use/en/code_review/general_config/bitbucket_pat
WEB_TOKEN_DOCS_AZUREREPOS=https://docs.kodus.io/how_to_use/en/code_review/general_config/azure_devops_pat

# Support URLs
WEB_SUPPORT_DOCS_URL="https://docs.kodus.io"
WEB_SUPPORT_DISCORD_INVITE_URL="https://discord.gg/QFzwwmNmdN"
WEB_SUPPORT_TALK_TO_FOUNDER_URL="https://cal.com/gabrielmalinosqui/30min"

# =============================================================================
# API / BACKEND VARIABLES
# =============================================================================

# Environment
API_NODE_ENV=production
API_DATABASE_ENV=production
API_LOG_LEVEL=info
API_LOG_PRETTY=false
API_CLOUD_MODE=false
API_DEVELOPMENT_MODE=false

# Server
API_HOST=0.0.0.0
API_PORT=3001
API_WEBHOOKS_PORT=3332
API_RATE_MAX_REQUEST=100
API_RATE_INTERVAL=1000
API_URL=http://localhost:3001
API_FRONTEND_URL=http://localhost:3000
NODE_ENV=production
LOG_LEVEL=info
COMPONENT_TYPE=api
CI=false

# PostgreSQL Database
API_PG_DB_HOST=db_postgres
API_PG_DB_PORT=5432
API_PG_DB_USERNAME=kodusdev
API_PG_DB_PASSWORD=changeme_strong_password
API_PG_DB_DATABASE=kodus_db

# PostgreSQL for Docker healthcheck (required by pg_isready)
POSTGRES_USER=kodusdev
POSTGRES_PASSWORD=changeme_strong_password
POSTGRES_DB=kodus_db

# MongoDB Database
API_MG_DB_HOST=db_mongodb
API_MG_DB_PORT=27017
API_MG_DB_USERNAME=kodusdev
API_MG_DB_PASSWORD=changeme_strong_password
API_MG_DB_DATABASE=kodus_db
API_MG_DB_AUTH_SOURCE=admin
API_MG_DB_PRODUCTION_CONFIG=''
MONGODB_URI=
MG_POOL_MAX_WORKER=20
MG_POOL_MAX_API=15
MG_POOL_MAX_WEBHOOK=10
MG_EXPORTER_POOL_MAX=20
MG_EXPORTER_POOL_MIN=5
MG_EXPORTER_SERVER_SELECTION_TIMEOUT_MS=10000
MG_EXPORTER_CONNECT_TIMEOUT_MS=10000
MG_EXPORTER_SOCKET_TIMEOUT_MS=30000
MG_EXPORTER_MAX_IDLE_TIME_MS=30000

# MongoDB for Docker (required by mongo image)
MONGO_INITDB_ROOT_USERNAME=kodusdev
MONGO_INITDB_ROOT_PASSWORD=changeme_strong_password

# RabbitMQ
API_RABBITMQ_ENABLED=true
API_RABBITMQ_URI=amqp://user:password@rabbitmq:5672/?heartbeat=60
RABBITMQ_URI=

# Workflow Outbox
WORKFLOW_OUTBOX_MAX_ATTEMPTS=3
WORKFLOW_OUTBOX_PUBLISH_TIMEOUT_MS=15000

# JWT Authentication
API_JWT_EXPIRES_IN=365d
API_JWT_SECRET=changeme_jwt_secret
API_JWT_REFRESHSECRET=changeme_refresh_secret
API_JWT_REFRESH_EXPIRES_IN=365d

# LLM Providers - Configure at least one
# OpenAI
API_OPEN_AI_API_KEY=

# Anthropic
API_ANTHROPIC_API_KEY=

# Google/Gemini
API_GOOGLE_AI_API_KEY=
GOOGLE_API_KEY=
GEMINI_API_KEY=
GEMINI_MODEL=gemini-1.5-flash

# OpenRouter (alternative)
API_OPENROUTER_KEY=
API_OPEN_ROUTER_API_KEY=

# Groq
API_GROQ_BASE_URL=https://api.groq.com/openai/v1
API_GROQ_API_KEY=

# Cerebras
API_CEREBRAS_BASE_URL=https://api.cerebras.ai/v1
API_CEREBRAS_API_KEY=

# LLM Model Selection
API_LLM_PROVIDER_MODEL="auto"
API_OPENAI_FORCE_BASE_URL=""

# GitHub Integration
API_GITHUB_APP_ID=
API_GITHUB_CLIENT_SECRET=
API_GITHUB_PRIVATE_KEY=""
API_GITHUB_CODE_MANAGEMENT_WEBHOOK="http://localhost:3001/github/webhook"
GITHUB_TOKEN=

# GitLab Integration
API_GITLAB_TOKEN_URL=""
API_GITLAB_CODE_MANAGEMENT_WEBHOOK=http://localhost:3001/gitlab/webhook

# Email Service
API_MAILSEND_API_TOKEN=
API_USER_INVITE_BASE_URL=http://localhost:3000

# AWS S3 (optional)
API_AWS_REGION=us-east-1
API_AWS_USERNAME=
API_AWS_PASSWORD=
API_AWS_BUCKET_NAME_ASSISTANT=kodus-assistant-files

# Sentry Error Tracking (optional)
API_SENTRY_DNS=""
SENTRY_RELEASE=

# LangChain Tracing (optional)
LANGCHAIN_TRACING_V2=false
LANGCHAIN_ENDPOINT=https://api.smith.langchain.com
LANGCHAIN_API_KEY=
LANGCHAIN_PROJECT=kodus-orchestrator
LANGCHAIN_CALLBACKS_BACKGROUND=false

# Cron Jobs
API_CRON_SYNC_CODE_REVIEW_REACTIONS="0 0 * * *"
API_CRON_KODY_LEARNING="0 0 * * 6"
API_CRON_CHECK_IF_PR_SHOULD_BE_APPROVED="*/2 * * * *"

# Microservices
KODUS_SERVICE_TEAMS=
KODUS_SERVICE_AZURE_REPOS=

# Google OAuth (optional)
API_GOOGLE_CLIENT_ID=
API_GOOGLE_CLIENT_SECRET=

# Vertex AI (optional)
API_VERTEX_AI_API_KEY=

# Novita AI (optional)
API_NOVITA_AI_API_KEY=

# Webhook Security
CODE_MANAGEMENT_SECRET=""
CODE_MANAGEMENT_WEBHOOK_TOKEN=""

# =============================================================================
# OBSERVABILITY (MongoDB)
# =============================================================================
# Sampling rate between 0 and 1 (e.g. 0.1 = 10%)
OBSERVABILITY_SAMPLING_RATE=
# TTL in days for observability logs (0 = no TTL)
OBSERVABILITY_TTL_DAYS=
# Enable/disable log writes
OBSERVABILITY_LOGS_ENABLED=
# Enable/disable telemetry
OBSERVABILITY_TELEMETRY_ENABLED=
# Batch and flush tuning
OBSERVABILITY_BATCH_SIZE=
OBSERVABILITY_FLUSH_INTERVAL_MS=
# Span timeout override
OBSERVABILITY_SPAN_TIMEOUT_MS=

# Internal Services
API_SERVICE_AST_URL="localhost:3002"
API_KODUS_SERVICE_MCP_MANAGER="localhost:3101"
API_KODUS_MCP_SERVER_URL=http://localhost:3001/mcp

# Feature Flags
API_ENABLE_CODE_REVIEW_AST=false
API_MCP_SERVER_ENABLED=true

# PostHog Analytics
API_POSTHOG_KEY=

# ECS Task Protection (for AWS ECS deployments)
API_ECS_AGENT_URI=http://localhost:5000
API_WORKER_DRAIN_TIMEOUT_MS=600000

# Encryption
API_CRYPTO_KEY=

# Segment Analytics (optional)
API_SEGMENT_KEY=

# MorphLLM (optional)
API_MORPHLLM_API_KEY=

# Signup Notification Webhook (optional)
API_SIGNUP_NOTIFICATION_WEBHOOK=

# =============================================================================
# DOCKER IMAGE VERSION
# =============================================================================
KODUS_VERSION=latest
