# Kodus AI Diff å¤„ç†å®Œæ•´æµç¨‹ - å¯è°ƒè¯•ç‰ˆæœ¬

ä» Kodus AI é¡¹ç›®ä¸­æå–çš„å®Œæ•´ Diff å¤„ç†ç®—æ³•ï¼ŒåŒ…å« 6 ä¸ªå¤„ç†æ­¥éª¤çš„è¯¦ç»†è°ƒè¯•è¾“å‡ºã€‚

## ğŸš€ å¿«é€Ÿå¼€å§‹

```bash
npm install
npm test
```

## ğŸ“Š å¤„ç†æµç¨‹ï¼ˆ6 ä¸ªæ­¥éª¤ï¼‰

```
PR Webhook
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 1: handlePatchDeletions                                    â”‚
â”‚ ç§»é™¤åªåˆ é™¤çš„ hunks â†’ èŠ‚çœ 27% tokens                             â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 2: convertToHunksWithLinesNumbers                          â”‚
â”‚ æ·»åŠ ç»å¯¹è¡Œå· â†’ LLM ç²¾ç¡®å®šä½ä»£ç ä½ç½®                               â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 3: extractLinesFromDiffHunk                                â”‚
â”‚ æå–ä¿®æ”¹èŒƒå›´ â†’ ç”¨äºè¿‡æ»¤ LLM å»ºè®®                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 4: getRelatedContentFromDiff (AST æœåŠ¡)                    â”‚
â”‚ ä»å®Œæ•´æ–‡ä»¶ä¸­æå–ç›¸å…³ä»£ç  â†’ èŠ‚çœ 26% tokens                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 5: initializeImpactAnalysis (AST æœåŠ¡)                     â”‚
â”‚ åˆ†æå‡½æ•°è°ƒç”¨é“¾ â†’ æ£€æµ‹ Breaking Changes                           â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ Step 6: MCP Tool Calls (Agent)                                  â”‚
â”‚ Agent è°ƒç”¨å¤–éƒ¨å·¥å…·è·å–é¢å¤–ä¸Šä¸‹æ–‡                                  â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
    â”‚
    â–¼
å‘é€ç»™ LLM
```

## ğŸ“ è¾“å‡ºç¤ºä¾‹

### åŸå§‹ Patch
```diff
@@ -10,12 +10,15 @@ import { Database } from '../database';
 import { Logger } from '../utils/logger';
 
 export class UserService {
-  private db: Database;
+  private readonly db: Database;
+  private readonly cache: Cache;
```

### å¤„ç†åï¼ˆå¸¦è¡Œå·ï¼‰
```
## file: 'src/services/userService.ts'

@@ -10,12 +10,15 @@ import { Database } from '../database';
__new hunk__
10  import { Logger } from '../utils/logger';
11  
12  export class UserService {
13 +  private readonly db: Database;
14 +  private readonly cache: Cache;
```

## ğŸ”§ ä»£ç ç»“æ„

```typescript
// åˆ›å»ºå¤„ç†å™¨
const processor = new DiffProcessor();

// å¤„ç† diff
const context = await processor.process(
    file,           // æ–‡ä»¶ä¿¡æ¯ + patch
    fileContent,    // å®Œæ•´æ–‡ä»¶å†…å®¹
    enableMockAST,  // å¯ç”¨ AST åˆ†ææ¨¡æ‹Ÿ
    enableMockMCP,  // å¯ç”¨ MCP å·¥å…·æ¨¡æ‹Ÿ
);

// æ‰“å°æ‰€æœ‰å¤„ç†æ­¥éª¤
DiffProcessor.printSteps(context);
```

## ğŸ“Š Token ä¼˜åŒ–æ•ˆæœ

| é˜¶æ®µ | ä¼˜åŒ– |
|------|------|
| handlePatchDeletions | 27% |
| getRelatedContentFromDiff | 26% |
| **æ€»è®¡** | **~50%** |

## ğŸ”— åŸå§‹ä»£ç ä½ç½®

| åŠŸèƒ½ | ä½ç½® |
|------|------|
| Diff å¤„ç† | `libs/common/utils/patch.ts` |
| AST æœåŠ¡ | `libs/ee/kodyAST/codeASTAnalysis.service.ts` |
| MCP Agent | `packages/kodus-flow/src/adapters/mcp/` |
| Pipeline | `libs/code-review/pipeline/stages/` |
