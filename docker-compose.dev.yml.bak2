x-app-service-template: &app-service-defaults
    build:
        context: .
        dockerfile: DockerFiles/Dockerfile.dev
        args:
            - API_CLOUD_MODE=${API_CLOUD_MODE:-false}
    env_file:
        - ${ENV_FILE:-.env}
    environment:
        - CHOKIDAR_USEPOLLING=true
        - CHOKIDAR_INTERVAL=3000
        - API_DEVELOPMENT_MODE=${API_DEVELOPMENT_MODE:-true}
    restart: unless-stopped
    volumes:
        - .:/usr/src/app:delegated
        - yalc_store:/root/.yalc
    networks:
        - kodus-backend-services
        - shared-network

services:
    #----------------------------------------------------------------
    # Application Services
    #----------------------------------------------------------------
    api:
        <<: *app-service-defaults
        container_name: kodus_api
        ports:
            - '${API_PORT:-3001}:${API_PORT:-3001}'
            - '9229:9229'
        # Entrypoint manages deps and migrations. Passing the start command.
        command: yarn start:dev:api
        deploy:
            resources:
                limits:
                    memory: 2G

        environment:
            - NODE_OPTIONS=--max-old-space-size=4096
            - DEBUG_PORT=9229
            - API_LOG_PRETTY=true
            - CHOKIDAR_USEPOLLING=true
            - CHOKIDAR_INTERVAL=3000
            - API_DEVELOPMENT_MODE=${API_DEVELOPMENT_MODE:-true}
            - RUN_MIGRATIONS=true

    worker:
        <<: *app-service-defaults
        container_name: kodus_worker
        ports:
            - '9231:9231'
        # Worker will also run migration on startup, which is OK as DB supports concurrency
        command: yarn start:dev:worker
        environment:
            - NODE_OPTIONS=--max-old-space-size=4096
            - DEBUG_PORT=9231
            - API_LOG_PRETTY=true
        deploy:
            resources:
                limits:
                    memory: 3G

    webhooks:
        <<: *app-service-defaults
        container_name: kodus_webhooks
        ports:
            - '${WEBHOOKS_PORT:-3332}:${WEBHOOKS_PORT:-3332}'
            - '9230:9230'
        command: yarn start:dev:webhooks
        environment:
            - NODE_OPTIONS=--max-old-space-size=4096
            - DEBUG_PORT=9230
            - API_LOG_PRETTY=true

    #----------------------------------------------------------------
    # Databases & Infrastructure
    #----------------------------------------------------------------
    db_postgres:
        profiles:
            - local-db
        image: pgvector/pgvector:pg16
        container_name: db_postgres
        ports:
            - '5432:5432'
        environment:
            POSTGRES_USER: ${API_PG_DB_USERNAME}
            POSTGRES_PASSWORD: ${API_PG_DB_PASSWORD}
            POSTGRES_DB: ${API_PG_DB_DATABASE}
        volumes:
            - pgdata:/var/lib/postgresql/data
            - ./docker-entrypoint-initdb.d:/docker-entrypoint-initdb.d
        networks:
            - kodus-backend-services
        restart: unless-stopped
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    'pg_isready -U ${API_PG_DB_USERNAME} -d ${API_PG_DB_DATABASE}',
                ]
            interval: 5s
            timeout: 3s
            retries: 20
            start_period: 10s

    db_mongodb:
        profiles:
            - local-db
        image: mongo:8
        container_name: mongodb
        ports:
            - '27017:27017'
        volumes:
            - mongodbdata:/data/db
        environment:
            MONGO_INITDB_ROOT_USERNAME: ${API_MG_DB_USERNAME}
            MONGO_INITDB_ROOT_PASSWORD: ${API_MG_DB_PASSWORD}
            MONGO_INITDB_DATABASE: ${API_MG_DB_DATABASE}
        networks:
            - kodus-backend-services
        restart: unless-stopped
        healthcheck:
            test:
                [
                    'CMD-SHELL',
                    "echo 'db.runCommand({ ping: 1 }).ok' | mongosh --quiet mongodb://$${MONGO_INITDB_ROOT_USERNAME}:$${MONGO_INITDB_ROOT_PASSWORD}@localhost:27017/admin | grep -q 1",
                ]
            interval: 10s
            timeout: 5s
            retries: 20
            start_period: 20s

    rabbitmq:
        profiles:
            - local-db
        image: rabbitmq:3-management
        container_name: rabbitmq
        ports:
            - '5672:5672'
            - '15672:15672'
        environment:
            RABBITMQ_DEFAULT_USER: ${API_RABBITMQ_USER:-user}
            RABBITMQ_DEFAULT_PASS: ${API_RABBITMQ_PASSWORD:-password}
        volumes:
            - rabbitmq_data:/var/lib/rabbitmq
        networks:
            - kodus-backend-services
            - shared-network
        restart: unless-stopped
        healthcheck:
            test: ['CMD-SHELL', 'rabbitmq-diagnostics -q ping']
            interval: 10s
            timeout: 5s
            retries: 10
            start_period: 30s

volumes:
    yalc_store:
    pgdata:
    mongodbdata:
    rabbitmq_data:

networks:
    kodus-backend-services:
        driver: bridge
        name: kodus-backend-services
        external: true
    shared-network:
        external: true

